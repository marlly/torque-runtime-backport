<project
  default="jar:jar"
  xmlns:deploy="deploy">

  <!-- Allow any user specific values to override the defaults -->
  <property file="${user.home}/build.properties" />
  <!-- Allow user defaults for this project -->
  <property file="build.properties" />
  <!-- Set default values for the build -->
  <property file="default.properties" />

  <!-- ================================================================== -->
  <!-- D I S T : B U I L D _ B I N   P R E   G O A L                      -->
  <!-- ================================================================== -->
  <!-- copies jars, templates, ... to the ${maven.dist.bin.assembly.dir}  -->
  <!-- to include them in the binary dists                                -->
  <!-- ================================================================== -->
  <preGoal name="dist:build-bin">

    <!-- copy schema files to the right place -->
<!--    
    <copy todir="${maven.dist.bin.assembly.dir}/schema">
      <fileset dir="${maven.src.dir}/schema" />
    </copy>
-->
    <!-- copy master files to the right place -->
    <copy todir="${maven.dist.bin.assembly.dir}/master">
      <fileset dir="${maven.src.dir}/conf/master" />
    </copy>

    <!-- copy config files to the right place -->
    <copy todir="${maven.dist.bin.assembly.dir}">
      <fileset dir="${maven.src.dir}/conf" />
    </copy>

    <!-- include listed dependencies -->
    <deploy:copy-deps todir="${maven.dist.bin.assembly.dir}/lib"/>

    <!-- move torque.jar to /lib -->
    <move
      file="${maven.dist.bin.assembly.dir}/${maven.final.name}.jar"
      todir="${maven.dist.bin.assembly.dir}/lib"
    />
  </preGoal>

  <!-- ================================================================== -->
  <!-- D I S T : L I T E                                                  -->
  <!-- ================================================================== -->
  <!-- binary distribution without jars used by scarab                    -->
  <!-- ================================================================== -->
  <goal name="dist:lite"
        prereqs="jar:jar"
        description="distribution without dependency jars">

    <!-- copy schema files to the right place -->
    <copy todir="${maven.dist.bin.assembly.dir}/schema">
      <fileset dir="${maven.src.dir}/schema" />
    </copy>

    <!-- copy master files to the right place -->
    <copy todir="${maven.dist.bin.assembly.dir}/master">
      <fileset dir="${maven.src.dir}/conf/master" />
    </copy>

    <!-- copy config files to the right place -->
    <copy todir="${maven.dist.bin.assembly.dir}">
      <fileset dir="${maven.src.dir}/conf" />
    </copy>

    <!-- Copy Jars -->
    <copy todir="${maven.dist.bin.assembly.dir}/lib">
      <fileset dir="${maven.build.dir}">
        <include name="${maven.final.name}.jar"/>
      </fileset>
    </copy>

    <!-- Create a zip file -->
    <zip zipfile="${maven.build.dir}/${maven.final.name}.zip">
      <zipfileset dir="${maven.dist.bin.assembly.dir}"/>
    </zip>
  </goal>

  <!-- ================================================================== -->
  <!-- R U N T I M E T E S T                                              -->
  <!-- ================================================================== -->
  <goal
    name="runtime:test"
    prereqs="runtime:prepare"
    description="runtime tests (set torque.testProfile in your build.properties)">

    <ant antfile="build-test.xml"
         target="test"
         inheritAll="false"/>
  </goal>

  <goal
    name="runtime:test-classpath"
    prereqs="runtime:prepare"
    description="runtime tests using useClasspath property (set torque.testProfile in your build.properties)">

    <ant antfile="build-test.xml"
         target="test-classpath"
         inheritAll="false"/>
  </goal>

  <goal
    name="runtime:prepare"
    prereqs="jar:jar">

    <!-- Set values in test profile -->
    <property file="${torque.testProfile}"/>

    <!-- Use the profile as the build.properties file
         in the dist directory so that it is customizable
         by each tester. -->
    <echo message="Copying profile into distribution directory: ${torque.testProfile}"/>

    <filter token="APPLICATION_ROOT" value="."/>
    <filter token="DATABASE" value="${torque.database}"/>
    <filter token="DATABASE_DEFAULT" value="${torque.defaultDatabase}"/>
    <filter token="DATABASE_URL" value="${torque.database.url}"/>
    <filter token="DATABASE_USER" value="${torque.database.user}"/>
    <filter token="DATABASE_DRIVER" value="${torque.database.driver}"/>
    <filter token="DATABASE_PASSWORD" value="${torque.database.password}"/>
    <filter token="DATABASE_ID_METHOD" value="${torque.idMethod}"/>
    <filter token="DATABASE_ADAPTER" value="${torque.database}"/>
    <filter token="VALIDATION_QUERY" value="${torque.database.validationQuery}"/>

    <copy
      tofile="${torque.distDir}/build.properties"
      file="${torque.testProfile}"
      overwrite="yes"
    />

    <!-- copy test schemas -->
    <copy
      todir="${torque.distDir}/schema"
      filtering="yes"
      overwrite="yes">
      <fileset dir="${rttest.dir}">
        <include name="**/*.xml"/>
      </fileset>
    </copy>

    <!-- copy test sql -->
    <copy
      todir="${torque.distDir}/sql"
      filtering="yes"
      overwrite="yes">
      <fileset dir="${rttest.dir}">
        <include name="*.sql"/>
        <include name="*.ref.xml"/>
      </fileset>
    </copy>

    <!-- copy test sources -->
    <copy todir="${torque.distDir}/src/java">
      <fileset dir="${rttest.dir}"/>
    </copy>

    <copy
      tofile="${build.test}/rttest/build-torque.xml"
      file="${torque.generator.home}/src/conf/build-torque.xml"
      overwrite="yes"
    />
    <copy
      tofile="${build.test}/rttest/default.properties"
      file="${src.dir}/generator/src/conf/default.properties"
      overwrite="yes"
    />

    <!-- copy libs -->
    <deploy:copy-deps todir="${build.test}/rttest/lib"/>
    <copy file="${maven.build.dir}/${maven.final.name}.jar"
          todir="${build.test}/rttest/lib"/>
    <copy todir="${build.test}/rttest/lib">
      <fileset dir="${torque.generator.home}/target/">
        <include name="*.jar"/>
      </fileset>
    </copy>
    <copy file="${torque.testDatabaseJar}"
          todir="${build.test}/rttest/lib"/>

    <!-- copy templates -->
    <copy todir="${build.test}/rttest/templates">
      <fileset dir="${torque.generator.home}/src/templates"/>
    </copy>

    <!-- copy Torque.properties -->
    <copy
      tofile="${build.test}/rttest/Torque.properties"
      file="src/conf/master/Torque.master"
      filtering="yes"
      overwrite="yes"
    />
  </goal>
  
  <!-- ================================================================== -->
  <!-- O J B   R U N T I M E T E S T                                      -->
  <!-- ================================================================== -->
  
  <goal
    name="runtime:test-ojb"
    prereqs="runtime:prepare-ojb"
    description="runtime tests for ojb tasks (set torque.testProfile in your build.properties)">

    <ant antfile="build-test.xml"
         target="test-ojb"
         inheritAll="false"/>
  </goal>
  
  <goal
    name="runtime:prepare-ojb"
    prereqs="jar:jar">

    <!-- Set values in test profile -->
    <property file="${torque.testProfile}"/>

    <!-- Use the profile as the build.properties file
         in the dist directory so that it is customizable
         by each tester. -->
    <echo message="Copying profile into distribution directory: ${torque.testProfile}"/>

    <filter token="APPLICATION_ROOT" value="."/>
    <filter token="DATABASE" value="${torque.database}"/>
    <filter token="DATABASE_DEFAULT" value="${torque.defaultDatabase}"/>
    <filter token="DATABASE_URL" value="${torque.database.url}"/>
    <filter token="DATABASE_USER" value="${torque.database.user}"/>
    <filter token="DATABASE_DRIVER" value="${torque.database.driver}"/>
    <filter token="DATABASE_PASSWORD" value="${torque.database.password}"/>
    <filter token="DATABASE_ID_METHOD" value="${torque.idMethod}"/>
    <filter token="DATABASE_ADAPTER" value="${torque.database}"/>

    <copy
      tofile="${test.ojb.distDir}/build.properties"
      file="${torque.testProfile}"
      overwrite="yes"
    />

    <!-- copy test schemas -->
    <copy
      todir="${test.ojb.distDir}/schema"
      filtering="yes"
      overwrite="yes">
      <fileset dir="${test.ojb.srcDir}">
        <include name="**/*.xml"/>
      </fileset>
    </copy>

    <!-- copy test sources -->
    <copy todir="${test.ojb.distDir}/src/java">
      <fileset dir="${test.ojb.srcDir}"/>
    </copy>

    <copy
      tofile="${test.ojb.distDir}/build-torque.xml"
      file="${torque.generator.home}/src/conf/build-torque.xml"
      overwrite="yes"
    />
    <copy
      tofile="${test.ojb.distDir}/default.properties"
      file="${src.dir}/generator/src/conf/default.properties"
      overwrite="yes"
    />

    <!-- copy libs -->
    <copy todir="${test.ojb.distDir}/lib">
      <fileset dir="${torque.generator.home}/target/">
        <include name="*.jar"/>
      </fileset>
    </copy>
    <copy file="${torque.testDatabaseJar}" todir="${test.ojb.distDir}/lib"/>
    <copy file="${ojb.jar}" todir="${test.ojb.distDir}/lib"/>
    <copy file="${commons-collections}" todir="${test.ojb.distDir}/lib"/>
  </goal>
  
</project>
